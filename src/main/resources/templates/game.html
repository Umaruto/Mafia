<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia: Web of Lies</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS Files -->
    <link rel="stylesheet" th:href="@{/css/actionHistory.css}">
    <link rel="stylesheet" th:href="@{/css/game.css}">
    <link rel="stylesheet" th:href="@{/css/animations.css}">
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-hover: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --shadow-color: rgba(0,0,0,0.1);
            --chat-bg: #ffffff;
            --header-bg: linear-gradient(135deg, #343a40, #495057);
        }

        body.night-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-hover: #404040;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #555555;
            --accent-color: #4dabf7;
            --success-color: #51cf66;
            --danger-color: #ff6b6b;
            --warning-color: #ffd43b;
            --info-color: #74c0fc;
            --shadow-color: rgba(0,0,0,0.3);
            --chat-bg: #2d2d2d;
            --header-bg: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }

        /* Base Styles */
        html, body {
            height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Main Container - Full Viewport */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .game-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: var(--bg-primary);
            overflow: hidden;
        }

        /* Header - Fixed Height */
        .game-header {
            background: var(--header-bg);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        /* Main Game Content - Flexible Layout */
        .game-content-wrapper {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        /* Left Panel - Players, Role, History */
        .left-panel {
            width: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        /* Right Panel - Game Actions and Chat */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Right Panel Content - Two Columns */
        .right-panel-content {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        /* Game Actions Column */
        .game-actions-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat Column */
        .chat-column {
            width: 350px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Panel Components */
        .panel-component {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-component h5 {
            margin: 0;
            padding: 12px 15px;
            background: var(--bg-hover);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-component h5 i {
            color: var(--accent-color);
        }

        /* Player List */
        .player-list {
            flex: 0 0 220px;
            min-height: 0;
            padding: 15px;
            overflow-y: auto;
        }

        /* Player List Items */
        #playersList {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .player-item {
            padding: 8px 12px;
            margin: 0;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .player-item:hover {
            background: var(--bg-hover);
            transform: translateX(2px);
        }

        .player-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .player-status {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--accent-color);
            color: white;
        }

        /* Role Info */
        .role-info {
            flex: 0 0 140px;
            min-height: 0;
            padding: 15px;
            overflow: hidden;
        }

        /* Action History */
        .action-history-section {
            flex: 1;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .action-history-header {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .action-history-header:hover {
            background: var(--bg-hover);
        }

        .action-history-header h5 {
            margin: 0;
            color: var(--text-primary);
        }

        .action-history-content {
            flex: 1;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .action-history-content.collapsed {
            height: 0;
            opacity: 0;
        }

        #actionHistoryPanel {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
        }
        
        /* Chat Section - Flexible, Takes Remaining Space */
        .chat-section {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 250px;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--chat-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            min-height: 200px;
        }

        /* Game Actions Panel */
        .game-actions {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Player Cards */
        .player-dead {
            background-color: #f8d7da;
            text-decoration: line-through;
            opacity: 0.7;
        }

        body.night-mode .player-dead {
            background-color: #5a2d2d;
        }
        
        /* Chat Message Styling */
        .chat-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
        }
        
        .chat-message.own-message {
            background-color: var(--accent-color);
            color: white;
            margin-left: 20%;
            text-align: right;
        }
        
        .chat-message.other-message {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: 20%;
        }
        
        .chat-message.system-message {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
            margin: 0;
            font-style: italic;
            text-align: center;
        }

        body.night-mode .chat-message.system-message {
            background-color: #3d3d1f;
            color: #ffc107;
        }
        
        .chat-message.mafia-message {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
            margin-right: 20%;
        }
        
        body.night-mode .chat-message.mafia-message {
            background-color: #5a2d2d;
            color: #ff6b6b;
        }

        /* Form Controls */
        .form-control, .form-select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-secondary);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(var(--accent-color), 0.25);
        }

        /* Buttons */
        .btn {
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        /* Phase Transition Effects */
        .game-container.day-phase {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        
        .game-container.night-phase {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }
        
        /* Elimination Animation */
        .elimination-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .elimination-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .elimination-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.5) rotateY(90deg);
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
            width: 90%;
        }
        
        .elimination-overlay.show .elimination-card {
            transform: scale(1) rotateY(0deg);
        }

        .elimination-card h3 {
            color: #dc3545;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .elimination-card .role-icon {
            font-size: 4rem;
            margin: 20px 0;
        }

        .elimination-card .player-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .elimination-card .role-name {
            font-size: 1.2rem;
            color: #6c757d;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar,
        .action-history-content::-webkit-scrollbar,
        .player-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track,
        .action-history-content::-webkit-scrollbar-track,
        .player-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        .chat-messages::-webkit-scrollbar-thumb,
        .action-history-content::-webkit-scrollbar-thumb,
        .player-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        /* Timer Styles */
        .timer-container {
            position: relative;
            margin-top: 15px;
        }
        
        .timer-progress {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 1s linear;
            border-radius: 3px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .right-panel-content {
                flex-direction: column;
            }
            
            .chat-column {
                width: auto;
                height: 300px;
                flex-shrink: 0;
            }
        }

        @media (max-width: 768px) {
            .game-content-wrapper {
                flex-direction: column;
            }
            
            .left-panel {
                width: auto;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                gap: 5px;
                padding: 10px;
            }
            
            .left-panel .panel-component {
                min-width: 200px;
                flex-shrink: 0;
            }
            
            .right-panel-content {
                flex-direction: column;
                gap: 5px;
            }
            
            .chat-column {
                width: auto;
                height: 250px;
            }
            
            .player-list, .role-info, .action-history-section {
                height: auto;
                min-height: 150px;
            }
        }
    </style>
</head>
<body id="gameBody">
    <!-- Elimination Animation Overlay -->
    <div id="eliminationOverlay" class="elimination-overlay">
        <div class="elimination-card">
            <h3>Player Eliminated!</h3>
            <div class="role-icon" id="eliminationRoleIcon">💀</div>
            <div class="player-name" id="eliminationPlayerName"></div>
            <div class="role-name" id="eliminationRoleName"></div>
        </div>
    </div>

    <div class="container-fluid game-container" id="gameContainer">
        <!-- Game Header -->
        <div class="game-header">
            <h1>Mafia: Web of Lies</h1>
                <div class="game-info">
                <span>Game Code: <span id="gameCode" th:text="${gameCode}"></span></span>
                    <input type="hidden" id="username" th:value="${username}">
                <span>Day: <span id="day">1</span></span>
                <span>Phase: <span id="phase">DAY</span></span>
                    
                    <!-- Sound Settings Button -->
                    <div class="float-end">
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="window.soundSettingsUI.show()" title="Sound Settings">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    <button type="button" class="btn btn-outline-light btn-sm ms-1" onclick="toggleSound()" id="soundToggleBtn" title="Toggle Sound">
                            <i class="fas fa-volume-up" id="soundToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Game Notifications -->
                <div id="gameNotifications" class="mt-2" style="display: none;">
                    <div class="alert alert-info notification" id="notificationText"></div>
            </div>
        </div>

        <!-- Main Game Content -->
        <div class="game-content-wrapper">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Player List -->
                <div class="player-list panel-component">
                    <h5><i class="fas fa-users"></i> Players</h5>
                    <div id="playersList">
                        <!-- Players will be dynamically added here -->
                    </div>
                </div>

                <!-- Role Info -->
                <div class="role-info panel-component">
                    <h5><i class="fas fa-id-card"></i> Your Role</h5>
                    <div id="roleInfo">
                        <p>Loading...</p>
                    </div>
                </div>

                <!-- Action History Panel -->
                <div class="action-history-section panel-component">
                    <div class="action-history-header" onclick="toggleActionHistory()">
                        <h5><i class="fas fa-history"></i> Action History</h5>
                        <i class="fas fa-chevron-up" id="actionHistoryToggle"></i>
                    </div>
                    <div class="action-history-content" id="actionHistoryContent">
                        <div id="actionHistoryPanel">
                            <!-- Action history will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Game Actions and Chat -->
            <div class="right-panel">
                <div class="right-panel-content">
                    <!-- Game Actions Column -->
                    <div class="game-actions-column">
                        <div class="game-actions panel-component">
                            <h3 id="phaseTitle">Game Actions</h3>
                            <div id="gameContent">
                                <!-- Day Phase Actions -->
                                <div id="dayPhase" style="display: none;">
                                    <h4>Day Phase - Discussion and Voting</h4>
                                    <p>Discuss with other players and vote to eliminate someone you suspect is Mafia.</p>
                                    
                                    <div class="voting-section mt-3">
                                        <label for="voteSelect">Vote to eliminate:</label>
                                        <select id="voteSelect" class="form-select mb-2">
                                            <option value="">Select a player...</option>
                                        </select>
                                        <div>
                                            <button id="voteBtn" class="btn btn-danger me-2">Vote</button>
                                            <button id="skipVoteBtn" class="btn btn-secondary">Skip Vote</button>
                                        </div>
                                    </div>
                                    
                                    <div id="votingStatus" class="mt-3">
                                        <h5>Voting Status:</h5>
                                        <div id="votesList"></div>
                                    </div>
                                </div>
                                
                                <!-- Night Phase Actions -->
                                <div id="nightPhase" style="display: none;">
                                    <h4>Night Phase</h4>
                                    <div id="nightActions">
                                        <!-- Role-specific actions will be shown here -->
                                    </div>
                                </div>

                                <!-- Game Over -->
                                <div id="gameOver" style="display: none;">
                                    <h4>Game Over!</h4>
                                    <div id="winnerMessage"></div>
                                    <button class="btn btn-primary mt-3" onclick="location.href='/'">Return to Home</button>
                                </div>
                                
                                <div class="mt-3">
                                    <button id="refreshBtn" class="btn btn-primary">Refresh Game State</button>
                                </div>
                                
                                <!-- Phase Timer -->
                                <div id="phaseTimer" class="mt-3 alert alert-warning" style="display: none;">
                                    <strong>Time Remaining: <span id="timerText">0:00</span></strong>
                                    <div class="timer-progress">
                                        <div class="timer-progress-bar" id="timerProgressBar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Column -->
                    <div class="chat-column">
                        <div class="chat-section panel-component">
                            <h5>
                                <i class="fas fa-comments"></i>
                                <span id="chatTitle">Public Chat</span>
                                <span id="chatPhaseIndicator" class="badge bg-primary ms-2">DAY</span>
                            </h5>
                            <div class="chat-container">
                                <div id="chatMessages" class="chat-messages">
                                    <!-- Chat messages will be displayed here -->
                                </div>
                                <div id="chatInputContainer" class="chat-input-container">
                                    <div class="input-group">
                                        <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." maxlength="1000" disabled>
                                        <button id="sendChatBtn" class="btn btn-primary" disabled>
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    <div id="chatStatus" class="small text-muted mt-1">
                                        Chat disabled - waiting for game to start
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chat functionality -->
    <script src="/js/chat.js"></script>
    
    <!-- Socket connection for real-time updates -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <!-- Sound Manager JavaScript -->
    <script th:src="@{/js/soundManager.js}"></script>
    <script th:src="@{/js/soundSettings.js}"></script>
    <!-- Animation Manager JavaScript -->
    <script th:src="@{/js/animations.js}"></script>

    <script th:inline="javascript">
        const gameCode = /*[[${gameCode}]]*/ '';
        const username = /*[[${username}]]*/ '';
        let currentPlayerRole = '';
        let phaseTimer = null;
        let currentPhase = '';
        let autoRefreshInterval = null;
        let hasActedThisNight = false;
        let isPlayerAlive = true;
        let isLoadingPlayers = false;
        let actionHistoryCollapsed = false;
        
        // Track shown eliminations to prevent repeats
        let shownEliminations = new Set();
        
        // Track chat initialization to prevent duplicates
        let chatInitialized = false;
        
        // Track current game state to prevent repeated phase processing
        let lastGameState = null;
        
        // Phase durations in seconds
        const NIGHT_PHASE_DURATION = 60;
        const DAY_PHASE_DURATION = 90;

        // Theme Management
        function updateTheme(phase) {
            const body = document.getElementById('gameBody');
            const container = document.getElementById('gameContainer');
            
            if (phase === 'NIGHT') {
                body.classList.add('night-mode');
                container.classList.remove('day-phase');
                container.classList.add('night-phase');
            } else {
                body.classList.remove('night-mode');
                container.classList.remove('night-phase');
                container.classList.add('day-phase');
            }
        }

        // Action History Toggle
        function toggleActionHistory() {
            const content = document.getElementById('actionHistoryContent');
            const toggle = document.getElementById('actionHistoryToggle');
            
            actionHistoryCollapsed = !actionHistoryCollapsed;
            
            if (actionHistoryCollapsed) {
                content.classList.add('collapsed');
                toggle.classList.remove('fa-chevron-up');
                toggle.classList.add('fa-chevron-down');
            } else {
                content.classList.remove('collapsed');
                toggle.classList.remove('fa-chevron-down');
                toggle.classList.add('fa-chevron-up');
            }
        }

        // Elimination Animation
        function showEliminationAnimation(playerName, role) {
            // Create a more comprehensive tracking key including current game state
            const eliminationKey = `${playerName}-${role}-${currentPhase || 'UNKNOWN'}`;
            if (shownEliminations.has(eliminationKey)) {
                return; // Already shown, don't show again
            }
            
            // Mark as shown
            shownEliminations.add(eliminationKey);
            
            const overlay = document.getElementById('eliminationOverlay');
            const playerNameEl = document.getElementById('eliminationPlayerName');
            const roleNameEl = document.getElementById('eliminationRoleName');
            const roleIconEl = document.getElementById('eliminationRoleIcon');
            
            // Set content
            playerNameEl.textContent = playerName;
            roleNameEl.textContent = role;
            
            // Set role icon
            const roleIcons = {
                'MAFIA': '🔫',
                'DETECTIVE': '🔍',
                'DOCTOR': '⚕️',
                'CIVILIAN': '👤'
            };
            roleIconEl.textContent = roleIcons[role] || '💀';
            
            // Show overlay
            overlay.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 3000);
            
            console.log(`Showing elimination animation for ${playerName} (${role}) in ${currentPhase} phase`);
        }

        // Game State Loading Functions
        function loadGameState() {
            const voteSelect = document.getElementById('voteSelect');
            const currentVoteSelection = voteSelect ? voteSelect.value : '';
            
            fetch(`/api/games/${gameCode}/player/${username}/role`)
                .then(response => response.json())
                .then(roleData => {
                    currentPlayerRole = roleData.role;
                    const roleInfo = document.getElementById('roleInfo');
                    
                    if (roleData.role === 'MAFIA') {
                        roleInfo.innerHTML = `
                            <h6 class="text-danger">${roleData.role}</h6>
                            <p class="small">${roleData.description}</p>
                            <div id="roleTeamInfo" class="mt-2">
                                <h6 class="small">Your Mafia Team:</h6>
                                <div id="roleMafiaMembers" class="small">Loading team...</div>
                            </div>
                        `;
                        loadMafiaTeamForRole();
                    } else {
                        const roleClass = roleData.role === 'DETECTIVE' ? 'text-info' : 
                                         roleData.role === 'DOCTOR' ? 'text-success' : 'text-secondary';
                        roleInfo.innerHTML = `
                            <h6 class="${roleClass}">${roleData.role}</h6>
                            <p class="small">${roleData.description}</p>
                        `;
                    }
                    
                    loadPlayersAndGameInfo();
                })
                .catch(error => {
                    console.error('Error loading role:', error);
                    document.getElementById('roleInfo').innerHTML = '<p>Error loading role information</p>';
                    loadPlayersAndGameInfo();
                });
        }

        function loadMafiaTeamForRole() {
            fetch(`/api/games/${gameCode}/mafia-team/${username}`)
                .then(response => response.json())
                .then(mafiaMembers => {
                    const roleMafiaDiv = document.getElementById('roleMafiaMembers');
                    if (roleMafiaDiv) {
                        roleMafiaDiv.innerHTML = '';
                        
                        if (mafiaMembers.length === 0) {
                            roleMafiaDiv.innerHTML = '<p class="text-muted small">No team information available</p>';
                            return;
                        }
                        
                        mafiaMembers.forEach(member => {
                            const memberDiv = document.createElement('div');
                            memberDiv.className = 'small mb-1';
                            
                            let memberText = member.username;
                            if (member.isYou) {
                                memberText += ' (You)';
                            }
                            if (!member.alive) {
                                memberText += ' (Dead)';
                                memberDiv.className += ' text-muted';
                                memberDiv.style.textDecoration = 'line-through';
                            }
                            
                            memberDiv.innerHTML = `<span class="text-danger">🔴 ${memberText}</span>`;
                            roleMafiaDiv.appendChild(memberDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading Mafia team for role:', error);
                    const roleMafiaDiv = document.getElementById('roleMafiaMembers');
                    if (roleMafiaDiv) {
                        roleMafiaDiv.innerHTML = '<p class="text-muted small">Unable to load team</p>';
                    }
                });
        }

        function loadPlayersAndGameInfo() {
            fetch(`/api/games/${gameCode}`)
                .then(response => response.json())
                .then(game => {
                    // Check if game state actually changed to prevent unnecessary processing
                    const gameStateKey = `${game.currentDay}-${game.currentPhase}-${game.gameState}`;
                    if (lastGameState === gameStateKey) {
                        // Only update player list if game state hasn't changed
                        loadPlayersList();
                        return;
                    }
                    lastGameState = gameStateKey;
                    
                    document.getElementById('day').textContent = game.currentDay;
                    
                    const phaseText = game.currentPhase === 0 ? 'DAY' : 'NIGHT';
                    document.getElementById('phase').textContent = phaseText;
                    document.getElementById('phaseTitle').textContent = `${phaseText} PHASE - Day ${game.currentDay}`;
                    
                    // Update theme based on phase
                    updateTheme(phaseText);
                    
                    loadPlayersList().then(() => {
                        if (game.gameState === 'FINISHED') {
                            showGameOver(game.winner);
                            clearTimer();
                            stopAutoRefresh();
                        } else if (game.currentPhase === 0) {
                            if (currentPhase !== 'DAY') {
                                currentPhase = 'DAY';
                                hasActedThisNight = false;
                                showDayPhase();
                                startPhaseTimer();
                                setAutoRefreshInterval(8000); // Reduced frequency during day
                                
                                if (window.soundManager) {
                                    window.soundManager.playGameEvent('PHASE_CHANGE', { phase: 'DAY' });
                                }
                                if (typeof updateChatPhase === 'function') {
                                updateChatPhase('DAY', currentPlayerRole, isPlayerAlive);
                                }
                            }
                            if (isPlayerAlive) {
                                loadVotingStatus();
                            }
                        } else {
                            if (currentPhase !== 'NIGHT') {
                                currentPhase = 'NIGHT';
                                hasActedThisNight = false;
                                showNightPhase();
                                startPhaseTimer();
                                setAutoRefreshInterval(15000); // Much reduced frequency during night
                                
                                if (window.soundManager) {
                                    window.soundManager.playGameEvent('PHASE_CHANGE', { phase: 'NIGHT' });
                                }
                                if (typeof updateChatPhase === 'function') {
                                updateChatPhase('NIGHT', currentPlayerRole, isPlayerAlive);
                                }
                            }
                        }
                        
                        // Update chat phase once after all phase logic is complete
                        const currentPhaseText = game.currentPhase === 0 ? 'DAY' : 'NIGHT';
                        if (typeof updateChatPhase === 'function') {
                            updateChatPhase(currentPhaseText, currentPlayerRole, isPlayerAlive);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading game state:', error);
                });
            
            loadActionHistory();
        }

        function loadPlayersList() {
            return new Promise((resolve, reject) => {
                if (isLoadingPlayers) {
                    resolve();
                    return;
                }
                
                isLoadingPlayers = true;
                
                fetch(`/api/games/${gameCode}/players`)
                    .then(response => response.json())
                    .then(players => {
                        const currentPlayer = players.find(p => p.username === username);
                        if (currentPlayer) {
                            isPlayerAlive = currentPlayer.alive;
                        }
                        
                        const voteSelect = document.getElementById('voteSelect');
                        if (voteSelect) {
                            const currentVoteSelection = voteSelect.value;
                            voteSelect.innerHTML = '<option value="">Select a player...</option>';
                            
                            players.forEach(player => {
                                if (player.username !== username && player.alive && isPlayerAlive) {
                                    const option = document.createElement('option');
                                    option.value = player.username;
                                    option.textContent = player.username;
                                    voteSelect.appendChild(option);
                                }
                            });
                            
                            if (currentVoteSelection && Array.from(voteSelect.options).some(opt => opt.value === currentVoteSelection)) {
                                voteSelect.value = currentVoteSelection;
                            }
                        }
                        
                        fetch(`/api/games/${gameCode}/dead-players-roles`)
                            .then(response => response.json())
                            .then(deadPlayersWithRoles => {
                                const deadPlayerRoles = {};
                                deadPlayersWithRoles.forEach(player => {
                                    deadPlayerRoles[player.username] = player.role;
                                });
                                
                                displayPlayersInList(players, deadPlayerRoles);
                                isLoadingPlayers = false;
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error loading dead player roles:', error);
                                displayPlayersInList(players, {});
                                isLoadingPlayers = false;
                                resolve();
                            });
                    })
                    .catch(error => {
                        console.error('Error loading players:', error);
                        isLoadingPlayers = false;
                        reject(error);
                    });
            });
        }

        function displayPlayersInList(players, deadPlayerRoles) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                if (!player.alive) {
                    playerDiv.classList.add('player-dead');
                }
                
                let playerText = player.username;
                if (player.username === username) {
                    playerText += ' (You)';
                }
                if (!player.alive) {
                    const role = deadPlayerRoles[player.username];
                    if (role) {
                        const roleColor = role === 'MAFIA' ? 'text-danger' : 
                                        role === 'DOCTOR' ? 'text-success' : 
                                        role === 'DETECTIVE' ? 'text-info' : 'text-secondary';
                        playerDiv.innerHTML = `<span>${player.username}${player.username === username ? ' (You)' : ''}</span> <span class="${roleColor}">(Dead - ${role})</span>`;
                        
                        // Trigger elimination animation for newly dead players
                        if (window.lastKnownPlayers) {
                            const wasAliveLastTime = window.lastKnownPlayers.find(p => p.username === player.username)?.alive;
                            if (wasAliveLastTime === true) {
                                // Player was alive last time, now dead - show elimination
                                showEliminationAnimation(player.username, role);
                            }
                        }
                    } else {
                        playerDiv.textContent = playerText + ' (Dead)';
                    }
                } else {
                    playerDiv.textContent = playerText;
                }
                
                playersList.appendChild(playerDiv);
            });
            
            // Store current players state
            window.lastKnownPlayers = players;
        }

        function showDayPhase() {
            document.getElementById('dayPhase').style.display = 'block';
            document.getElementById('nightPhase').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            if (!isPlayerAlive) {
                document.getElementById('dayPhase').innerHTML = `
                    <div class="alert alert-secondary">
                        <h4>Day Phase - Spectator Mode</h4>
                        <p><strong>You are dead and watching the game.</strong></p>
                        <p>The living players are discussing and voting to eliminate someone they suspect is Mafia.</p>
                        <p>You cannot participate but can observe the proceedings.</p>
                    </div>
                    <div id="votingStatus" class="mt-3">
                        <h5>Voting Status:</h5>
                        <div id="votesList"></div>
                    </div>
                `;
            }
        }

        function showNightPhase() {
            document.getElementById('dayPhase').style.display = 'none';
            document.getElementById('nightPhase').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';
            
            const nightActions = document.getElementById('nightActions');
            if (!isPlayerAlive) {
                nightActions.innerHTML = `
                    <div class="alert alert-secondary">
                        <h4>Night Phase - Spectator Mode</h4>
                        <p><strong>You are dead and watching the game.</strong></p>
                        <p>The living players with special roles are performing their night actions.</p>
                        <p>Wait for the day phase to see the results of tonight's actions.</p>
                    </div>
                `;
                return;
            }
            
            if (currentPlayerRole === 'MAFIA') {
                nightActions.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Mafia Night Action</h5>
                        <p>Vote for a player to eliminate tonight.</p>
                        <div class="mt-3">
                            <label for="mafiaTarget">Your vote to eliminate:</label>
                            <select id="mafiaTarget" class="form-select mb-2">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="mafiaActionBtn" class="btn btn-danger">Submit Vote</button>
                        </div>
                    </div>
                `;
                loadMafiaTargets();
                document.getElementById('mafiaActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('mafiaTarget').value;
                    if (!target) {
                            alert('Please select a target to eliminate.');
                        return;
                    }
                    submitNightAction('KILL', target);
                });
            } else if (currentPlayerRole === 'DOCTOR') {
                nightActions.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Doctor Night Action</h5>
                        <p>Choose a player to save tonight.</p>
                        <div class="mt-3">
                            <label for="doctorTarget">Player to save:</label>
                            <select id="doctorTarget" class="form-select mb-2">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="doctorActionBtn" class="btn btn-success">Save Player</button>
                        </div>
                    </div>
                `;
                loadDoctorTargets();
                document.getElementById('doctorActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('doctorTarget').value;
                    if (!target) {
                            alert('Please select a player to save.');
                        return;
                    }
                    submitNightAction('SAVE', target);
                });
            } else if (currentPlayerRole === 'DETECTIVE') {
                nightActions.innerHTML = `
                    <div class="alert alert-info">
                        <h5>Detective Night Action</h5>
                        <p>Choose a player to investigate tonight.</p>
                        <div class="mt-3">
                            <label for="detectiveTarget">Player to investigate:</label>
                            <select id="detectiveTarget" class="form-select mb-2">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="detectiveActionBtn" class="btn btn-info">Investigate Player</button>
                        </div>
                    </div>
                `;
                loadDetectiveTargets();
                document.getElementById('detectiveActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('detectiveTarget').value;
                    if (!target) {
                            alert('Please select a player to investigate.');
                        return;
                    }
                    submitNightAction('INVESTIGATE', target);
                });
            } else {
                nightActions.innerHTML = `
                    <div class="alert alert-secondary">
                        <h5>Night Time</h5>
                        <p>Sleep tight! The night actions are being performed by special roles.</p>
                        <p>Wait for the day phase to begin where you can participate in discussions and voting.</p>
                    </div>
                `;
            }
        }

        function loadMafiaTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('mafiaTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.username !== username && player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function loadDoctorTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('doctorTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function loadDetectiveTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('detectiveTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.username !== username && player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function submitNightAction(actionType, targetUsername) {
            const nightActionData = {
                actorUsername: username,
                targetUsername: targetUsername,
                actionType: actionType
            };
            
            fetch(`/api/game-logic/${gameCode}/night-action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nightActionData)
            })
            .then(response => {
                if (response.ok) {
                        hasActedThisNight = true;
                    alert('Action submitted successfully!');
                        if (window.soundManager) {
                        window.soundManager.playGameEvent('NIGHT_ACTION', { role: currentPlayerRole });
                    }
                } else {
                    return response.json().then(error => {
                        throw new Error(error.message || 'Failed to perform night action');
                    });
                }
            })
            .catch(error => {
                console.error('Error performing night action:', error);
                alert('Error: ' + error.message);
            });
        }

        function showGameOver(winner) {
            document.getElementById('dayPhase').style.display = 'none';
            document.getElementById('nightPhase').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            
            const winnerMessage = document.getElementById('winnerMessage');
            if (winner === 'MAFIA') {
                winnerMessage.innerHTML = '<h5 class="text-danger">Mafia Wins!</h5><p>The Mafia has successfully taken over the town.</p>';
            } else if (winner === 'CITIZENS') {
                winnerMessage.innerHTML = '<h5 class="text-success">Citizens Win!</h5><p>All Mafia members have been eliminated!</p>';
            } else {
                winnerMessage.innerHTML = '<h5 class="text-info">Game Over!</h5><p>The game has ended.</p>';
                }
            }
            
        function loadVotingStatus() {
            fetch(`/api/game-logic/${gameCode}/vote-status`)
                .then(response => response.json())
                .then(votingStatus => {
                    const votesList = document.getElementById('votesList');
                    if (!votesList) return;
                    
                    votesList.innerHTML = '';
                    
                    Object.entries(votingStatus).forEach(([playerName, status]) => {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'vote-status-item d-flex justify-content-between align-items-center p-2 mb-1 bg-light rounded';
                        
                        let statusClass = 'text-warning';
                        if (status.startsWith('Voted')) {
                            statusClass = 'text-success';
                        }
                        
                        statusDiv.innerHTML = `
                            <span>${playerName}:</span>
                            <span class="${statusClass}">${status}</span>
                        `;
                        votesList.appendChild(statusDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading voting status:', error);
                });
        }

        function loadActionHistory() {
            fetch(`/api/history/game/${gameCode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load action history');
                    }
                    return response.json();
                })
                .then(actions => {
                    displayActionHistory(actions);
                })
                .catch(error => {
                    console.error('Error loading action history:', error);
                    document.getElementById('actionHistoryPanel').innerHTML = 
                        '<p class="text-muted small">Unable to load action history</p>';
                });
        }

        function displayActionHistory(actions) {
            const panel = document.getElementById('actionHistoryPanel');
            
            if (!actions || actions.length === 0) {
                panel.innerHTML = '<p class="text-muted small">No actions recorded yet</p>';
                return;
            }
            
            actions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentActions = actions.slice(0, 5);

            let html = '';
            recentActions.forEach(action => {
                const time = new Date(action.timestamp).toLocaleTimeString();
                html += `
                    <div class="small mb-2 p-2 border-bottom">
                        <div class="text-muted">${time} - Day ${action.day}</div>
                        <div>${action.details || 'No details available'}</div>
                    </div>
                `;
            });

            panel.innerHTML = html;
        }

        function startPhaseTimer() {
            // Clear any existing timer
            clearTimer();
            
            // Fetch timer status from server
            fetch(`/api/games/${gameCode}/timer-status`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Timer API not available');
                    }
                    return response.json();
                })
                .then(timerData => {
                    if (timerData && timerData.remainingTime > 0) {
                        const timerElement = document.getElementById('phaseTimer');
                        const timerText = document.getElementById('timerText');
                        const progressBar = document.getElementById('timerProgressBar');
                        
                        let timeLeft = timerData.remainingTime;
                        const totalTime = timerData.totalTime || (currentPhase === 'DAY' ? DAY_PHASE_DURATION : NIGHT_PHASE_DURATION);
                        
                        // Show timer
                        timerElement.style.display = 'block';
                        
                        // Update timer every second
                        phaseTimer = setInterval(() => {
                            const minutes = Math.floor(timeLeft / 60);
                            const seconds = timeLeft % 60;
                            timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            
                            // Update progress bar
                            const progressPercent = (timeLeft / totalTime) * 100;
                            progressBar.style.width = `${progressPercent}%`;
                            
                            // Change color based on time remaining
                            if (timeLeft <= 10) {
                                timerElement.className = 'mt-3 alert alert-danger';
                                progressBar.className = 'timer-progress-bar bg-danger';
                            } else if (timeLeft <= 30) {
                                timerElement.className = 'mt-3 alert alert-warning';
                                progressBar.className = 'timer-progress-bar bg-warning';
                            }
                            
                            timeLeft--;
                            
                            if (timeLeft < 0) {
                                clearTimer();
                                timerElement.style.display = 'none';
                            }
                        }, 1000);
                    } else {
                        // No timer active or time expired
                        document.getElementById('phaseTimer').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.log('Timer API not available, using fallback timer');
                    // Fallback: Create a simple countdown timer
                    const timerElement = document.getElementById('phaseTimer');
                    const timerText = document.getElementById('timerText');
                    const progressBar = document.getElementById('timerProgressBar');
                    
                    // Set default time based on phase
                    let timeLeft = currentPhase === 'DAY' ? DAY_PHASE_DURATION : NIGHT_PHASE_DURATION;
                    const totalTime = timeLeft;
                    
                    // Show timer
                    timerElement.style.display = 'block';
                    timerElement.className = 'mt-3 alert alert-info';
                    
                    // Update timer every second
                    phaseTimer = setInterval(() => {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Update progress bar
                        const progressPercent = (timeLeft / totalTime) * 100;
                        progressBar.style.width = `${progressPercent}%`;
                        
                        // Change color based on time remaining
                        if (timeLeft <= 10) {
                            timerElement.className = 'mt-3 alert alert-danger';
                            progressBar.className = 'timer-progress-bar bg-danger';
                        } else if (timeLeft <= 30) {
                            timerElement.className = 'mt-3 alert alert-warning';
                            progressBar.className = 'timer-progress-bar bg-warning';
                        }
                        
                        timeLeft--;
                        
                        if (timeLeft < 0) {
                            clearTimer();
                            timerElement.style.display = 'none';
                        }
                    }, 1000);
                });
        }

        function clearTimer() {
            if (phaseTimer) {
                clearInterval(phaseTimer);
                phaseTimer = null;
            }
        }

        function setAutoRefreshInterval(interval) {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(loadGameState, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function toggleSound() {
            if (window.soundManager) {
                const enabled = window.soundManager.toggle();
                const icon = document.getElementById('soundToggleIcon');
                const btn = document.getElementById('soundToggleBtn');
                if (enabled) {
                    icon.className = 'fas fa-volume-up';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-outline-light');
                        } else {
                    icon.className = 'fas fa-volume-mute';
                    btn.classList.remove('btn-outline-light');
                    btn.classList.add('btn-outline-danger');
                }
            }
        }

        // Event Listeners
        document.getElementById('voteBtn').addEventListener('click', function() {
            if (!isPlayerAlive) {
                alert('Dead players cannot vote! You are in spectator mode.');
                        return;
                    }
                    
            const selectedPlayer = document.getElementById('voteSelect').value;
            if (!selectedPlayer) {
                alert('Please select a player to vote for.');
                return;
            }
            
                    const voteData = {
                        voterUsername: username,
                        targetUsername: selectedPlayer,
                        skip: false
                    };
                    
                    fetch(`/api/game-logic/${gameCode}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(voteData)
                    })
                    .then(response => {
                        if (response.ok) {
                                alert(`Successfully voted for ${selectedPlayer}`);
                            document.getElementById('voteSelect').value = '';
                            loadVotingStatus();
                            loadGameState();
                        } else {
                            return response.json().then(error => {
                                throw new Error(error.message || 'Failed to vote');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error voting:', error);
                            alert('Error: ' + error.message);
                });
        });

        document.getElementById('skipVoteBtn').addEventListener('click', function() {
            if (!isPlayerAlive) {
                alert('Dead players cannot vote! You are in spectator mode.');
                return;
            }
            
                    const voteData = {
                        voterUsername: username,
                        targetUsername: null,
                        skip: true
                    };
                    
                    fetch(`/api/game-logic/${gameCode}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(voteData)
                    })
                    .then(response => {
                        if (response.ok) {
                                alert('Successfully skipped vote');
                            loadVotingStatus();
                            loadGameState();
                        } else {
                            return response.json().then(error => {
                                throw new Error(error.message || 'Failed to skip vote');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error skipping vote:', error);
                            alert('Error: ' + error.message);
                });
        });

        document.getElementById('refreshBtn').addEventListener('click', loadGameState);

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Initialize chat only once
                if (typeof initializeChat === 'function' && !chatInitialized) {
                    initializeChat(gameCode, username);
                    chatInitialized = true;
                }
                
                loadGameState();
                setAutoRefreshInterval(5000);

                if (window.soundManager) {
                    const settings = window.soundManager.getSettings();
                    const icon = document.getElementById('soundToggleIcon');
                    const btn = document.getElementById('soundToggleBtn');
                    if (!settings.enabled) {
                        icon.className = 'fas fa-volume-mute';
                        btn.classList.remove('btn-outline-light');
                        btn.classList.add('btn-outline-danger');
                    }
                }
            }, 100);
        });
    </script>
</body>
</html>