<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia: Web of Lies</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS Files -->
    <link rel="stylesheet" th:href="@{/css/actionHistory.css}">
    <link rel="stylesheet" th:href="@{/css/game.css}">
    <link rel="stylesheet" th:href="@{/css/animations.css}">
    <style>
        .game-container {
            padding: 20px;
        }
        .game-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .player-list {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .player-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }
        .player-dead {
            background-color: #f8d7da;
            text-decoration: line-through;
        }
        .game-actions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .role-info {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .action-history-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .vote-status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            margin: 3px 0;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }
        .vote-status.voted {
            color: #28a745;
            font-weight: bold;
        }
        .vote-status.not-voted {
            color: #dc3545;
        }
        .player-name {
            font-weight: 500;
        }
        .text-danger {
            color: #dc3545 !important;
            font-weight: bold;
        }
        .text-success {
            color: #28a745 !important;
            font-weight: bold;
        }
        .text-info {
            color: #17a2b8 !important;
            font-weight: bold;
        }
        .text-secondary {
            color: #6c757d !important;
            font-weight: bold;
        }
        
        /* Enhanced timer styles */
        .timer-container {
            position: relative;
            margin-top: 15px;
        }
        
        .timer-progress {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 1s linear;
            border-radius: 3px;
        }
        
        /* Chat Section Styles */
        .chat-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }
        
        .chat-messages {
            flex-grow: 1;
            max-height: 250px;
            min-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .chat-message {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-radius: 8px;
            word-wrap: break-word;
            position: relative;
        }
        
        .chat-message.own-message {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
            text-align: right;
        }
        
        .chat-message.other-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        
        .chat-message.system-message {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
            margin: 0;
            font-style: italic;
            text-align: center;
        }
        
        .chat-message.mafia-message {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
            margin-right: 20%;
        }
        
        .chat-message .sender {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        
        .chat-message .timestamp {
            font-size: 0.75em;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .chat-message .content {
            margin-top: 2px;
        }
        
        .chat-input-container {
            margin-top: auto;
        }
        
        #chatInput:disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        #chatPhaseIndicator.day {
            background-color: #28a745 !important;
        }
        
        #chatPhaseIndicator.night {
            background-color: #6c757d !important;
        }
        
        #chatPhaseIndicator.mafia-night {
            background-color: #dc3545 !important;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container-fluid game-container">
        <!-- Game Header -->
        <div class="row">
            <div class="col">
                <div class="game-header transition-all hover-lift">
                <h1 class="animate-fade-in">Mafia: Web of Lies</h1>
                <div class="game-info">
                    <span class="transition-all hover-scale">Game Code: <span id="gameCode" th:text="${gameCode}"></span></span>
                    <input type="hidden" id="username" th:value="${username}">
                    <span class="transition-all hover-scale">Day: <span id="day">1</span></span>
                    <span class="transition-all hover-scale">Phase: <span id="phase">DAY</span></span>
                    
                    <!-- Sound Settings Button -->
                    <div class="float-end">
                        <button type="button" class="btn btn-outline-secondary btn-sm action-button" onclick="window.soundSettingsUI.show()" title="Sound Settings">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-1 action-button" onclick="toggleSound()" id="soundToggleBtn" title="Toggle Sound">
                            <i class="fas fa-volume-up" id="soundToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Game Notifications -->
                <div id="gameNotifications" class="mt-2" style="display: none;">
                    <div class="alert alert-info notification" id="notificationText"></div>
                </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Player List -->
            <div class="col-md-4">
                <div class="player-list transition-all hover-lift">
                <h3 class="animate-slide-in-left">Players</h3>
                    <div id="playersList">
                    <!-- Players will be dynamically added here -->
                    </div>
                </div>

                <div class="role-info transition-all hover-lift">
                    <h4 class="animate-slide-in-left">Your Role</h4>
                    <div id="roleInfo">
                        <p>Loading...</p>
                    </div>
                </div>

                <!-- Action History Panel -->
                <div class="action-history-section transition-all hover-lift">
                    <h4 class="animate-slide-in-left">Action History</h4>
                    <div id="actionHistoryPanel">
                        <!-- Action history will be loaded here -->
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="chat-section transition-all hover-lift">
                    <h4 class="animate-slide-in-left">
                        <span id="chatTitle">Public Chat</span>
                        <span id="chatPhaseIndicator" class="badge bg-primary ms-2">DAY</span>
                    </h4>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <!-- Chat messages will be displayed here -->
                        </div>
                        <div id="chatInputContainer" class="chat-input-container">
                            <div class="input-group">
                                <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." maxlength="1000" disabled>
                                <button id="sendChatBtn" class="btn btn-primary action-button" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div id="chatStatus" class="small text-muted mt-1">
                                Chat disabled - waiting for game to start
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Actions -->
            <div class="col-md-8">
                <div class="game-actions transition-all hover-lift">
                    <h3 id="phaseTitle" class="animate-fade-in">Game Actions</h3>
                    <div id="gameContent">
                        <!-- Day Phase Actions -->
                        <div id="dayPhase" style="display: none;" class="animate-slide-in-up">
                            <h4>Day Phase - Discussion and Voting</h4>
                            <p>Discuss with other players and vote to eliminate someone you suspect is Mafia.</p>
                            
                            <div class="voting-section mt-3">
                                <label for="voteSelect">Vote to eliminate:</label>
                                <select id="voteSelect" class="form-select mb-2 transition-all">
                                    <option value="">Select a player...</option>
                                </select>
                                <div>
                                    <button id="voteBtn" class="btn btn-danger me-2 action-button hover-lift">Vote</button>
                                    <button id="skipVoteBtn" class="btn btn-secondary action-button hover-lift">Skip Vote</button>
                </div>
                </div>
                            
                            <div id="votingStatus" class="mt-3">
                                <h5>Voting Status:</h5>
                                <div id="votesList"></div>
                </div>
            </div>
                        
                        <!-- Night Phase Actions -->
                        <div id="nightPhase" style="display: none;" class="animate-slide-in-up">
                            <h4>Night Phase</h4>
                            <div id="nightActions">
                                <!-- Role-specific actions will be shown here -->
        </div>
    </div>

                        <!-- Game Over -->
                        <div id="gameOver" style="display: none;" class="animate-zoom-in">
                            <h4>Game Over!</h4>
                            <div id="winnerMessage"></div>
                            <button class="btn btn-primary mt-3 action-button hover-lift" onclick="location.href='/'">Return to Home</button>
                        </div>
                        
                        <div class="mt-3">
                            <button id="refreshBtn" class="btn btn-primary action-button hover-lift">Refresh Game State</button>
                        </div>
                        
                        <!-- Phase Timer -->
                        <div id="phaseTimer" class="mt-3 alert alert-warning" style="display: none;">
                            <strong>Time Remaining: <span id="timerText">0:00</span></strong>
                </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <!-- Sound Manager JavaScript -->
    <script th:src="@{/js/soundManager.js}"></script>
    <script th:src="@{/js/soundSettings.js}"></script>
    <!-- Animation Manager JavaScript -->
    <script th:src="@{/js/animations.js}"></script>
    <!-- Chat Manager JavaScript -->
    <script th:src="@{/js/chat.js}"></script>
    <script th:inline="javascript">
        const gameCode = /*[[${gameCode}]]*/ '';
        const username = /*[[${username}]]*/ '';
        let currentPlayerRole = '';
        let phaseTimer = null;
        let currentPhase = '';
        let autoRefreshInterval = null;
        let hasActedThisNight = false;
        let isPlayerAlive = true; // Track if current player is alive
        let isLoadingPlayers = false; // Flag to prevent concurrent player loading
        
        // Phase durations in seconds
        const NIGHT_PHASE_DURATION = 60; // 60 seconds (1 minute) for night actions
        const DAY_PHASE_DURATION = 90;   // 1.5 minutes for day votes

        function loadGameState() {
            // Store current vote selection to preserve it during refresh
            const voteSelect = document.getElementById('voteSelect');
            const currentVoteSelection = voteSelect ? voteSelect.value : '';
            
            // Load player role first, then load other game state
            fetch(`/api/games/${gameCode}/player/${username}/role`)
                .then(response => response.json())
                .then(roleData => {
                    currentPlayerRole = roleData.role;
                    const roleInfo = document.getElementById('roleInfo');
                    
                    if (roleData.role === 'MAFIA') {
                        roleInfo.innerHTML = `
                            <h5 class="role-reveal role-mafia">${roleData.role}</h5>
                            <p>${roleData.description}</p>
                            <div id="roleTeamInfo" class="mt-3">
                                <h6>Your Mafia Team:</h6>
                                <div id="roleMafiaMembers">Loading team...</div>
                            </div>
                        `;
                        // Load Mafia team info for role section
                        loadMafiaTeamForRole();
                    } else {
                        const roleClass = roleData.role === 'DETECTIVE' ? 'role-detective' : 
                                         roleData.role === 'DOCTOR' ? 'role-doctor' : 'role-civilian';
                        roleInfo.innerHTML = `
                            <h5 class="role-reveal ${roleClass}">${roleData.role}</h5>
                            <p>${roleData.description}</p>
                        `;
                    }
                    
                    // Animate role reveal
                    if (window.animationManager) {
                        window.animationManager.animateRoleReveal(roleInfo.querySelector('h5'), roleData.role);
                    }
                    
                    // Now load the rest of the game state after role is loaded
                    loadPlayersAndGameInfo();
                })
                .catch(error => {
                    console.error('Error loading role:', error);
                    document.getElementById('roleInfo').innerHTML = '<p>Error loading role information</p>';
                    // Still load game state even if role loading fails
                    loadPlayersAndGameInfo();
                });
        }

        function loadMafiaTeamForRole() {
            fetch(`/api/games/${gameCode}/mafia-team/${username}`)
                .then(response => response.json())
                .then(mafiaMembers => {
                    const roleMafiaDiv = document.getElementById('roleMafiaMembers');
                    if (roleMafiaDiv) {
                        roleMafiaDiv.innerHTML = '';
                        
                        if (mafiaMembers.length === 0) {
                            roleMafiaDiv.innerHTML = '<p class="text-muted small">No team information available</p>';
                            return;
                        }
                        
                        mafiaMembers.forEach(member => {
                            const memberDiv = document.createElement('div');
                            memberDiv.className = 'small mb-1';
                            
                            let memberText = member.username;
                            if (member.isYou) {
                                memberText += ' (You)';
                            }
                            if (!member.alive) {
                                memberText += ' (Dead)';
                                memberDiv.className += ' text-muted';
                                memberDiv.style.textDecoration = 'line-through';
                            }
                            
                            memberDiv.innerHTML = `<span class="text-danger">ðŸ”´ ${memberText}</span>`;
                            roleMafiaDiv.appendChild(memberDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading Mafia team for role:', error);
                    const roleMafiaDiv = document.getElementById('roleMafiaMembers');
                    if (roleMafiaDiv) {
                        roleMafiaDiv.innerHTML = '<p class="text-muted small">Unable to load team</p>';
                    }
                });
        }

        function loadPlayersAndGameInfo() {
            // Load game info first to determine phase
            fetch(`/api/games/${gameCode}`)
                .then(response => response.json())
                .then(game => {
                    document.getElementById('day').textContent = game.currentDay;
                    
                    // Update phase display
                    const phaseText = game.currentPhase === 0 ? 'DAY' : 'NIGHT';
                    document.getElementById('phase').textContent = phaseText;
                    document.getElementById('phaseTitle').textContent = `${phaseText} PHASE - Day ${game.currentDay}`;
                    
                    // Always load players first to update isPlayerAlive status
                    loadPlayersList().then(() => {
                        // Show appropriate phase content after player status is updated
                        if (game.gameState === 'FINISHED') {
                            showGameOver(game.winner);
                            clearTimer();
                            stopAutoRefresh();
                        } else if (game.currentPhase === 0) {
                            if (currentPhase !== 'DAY') {
                                currentPhase = 'DAY';
                                hasActedThisNight = false;
                                showDayPhase();
                                startPhaseTimer(DAY_PHASE_DURATION);
                                setAutoRefreshInterval(5000); // Normal refresh during day
                                // Play day phase sound
                                if (window.soundManager) {
                                    window.soundManager.playGameEvent('PHASE_CHANGE', { phase: 'DAY' });
                                }
                                // Update chat for day phase
                                updateChatPhase('DAY', currentPlayerRole, isPlayerAlive);
                            }
                            if (isPlayerAlive) {
                                loadVotingStatus();
                            }
                        } else {
                            if (currentPhase !== 'NIGHT') {
                                currentPhase = 'NIGHT';
                                hasActedThisNight = false;
                                showNightPhase();
                                startPhaseTimer(NIGHT_PHASE_DURATION);
                                setAutoRefreshInterval(10000); // Slower refresh during night
                                // Play night phase sound
                                if (window.soundManager) {
                                    window.soundManager.playGameEvent('PHASE_CHANGE', { phase: 'NIGHT' });
                                }
                                // Update chat for night phase
                                updateChatPhase('NIGHT', currentPlayerRole, isPlayerAlive);
                            }
                        }
                        
                        // Always update chat to ensure it's properly configured
                        const currentPhaseText = game.currentPhase === 0 ? 'DAY' : 'NIGHT';
                        if (typeof updateChatPhase === 'function') {
                            updateChatPhase(currentPhaseText, currentPlayerRole, isPlayerAlive);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading game state:', error);
                });
            
            // Also load action history
            loadActionHistory();
        }

        function loadPlayersList() {
            return new Promise((resolve, reject) => {
                // Prevent concurrent loading
                if (isLoadingPlayers) {
                    resolve();
                    return;
                }
                
                isLoadingPlayers = true;
                
                // Load players
                fetch(`/api/games/${gameCode}/players`)
                    .then(response => response.json())
                    .then(players => {
                        // Update isPlayerAlive status first
                        const currentPlayer = players.find(p => p.username === username);
                        if (currentPlayer) {
                            isPlayerAlive = currentPlayer.alive;
                        }
                        
                        // Update vote select options only if player is alive and it's day phase
                        const voteSelect = document.getElementById('voteSelect');
                        if (voteSelect) {
                            const currentVoteSelection = voteSelect.value;
                            voteSelect.innerHTML = '<option value="">Select a player...</option>';
                            
                            players.forEach(player => {
                                // Add to vote options (exclude self and dead players) only if current player is alive
                                if (player.username !== username && player.alive && isPlayerAlive) {
                                    const option = document.createElement('option');
                                    option.value = player.username;
                                    option.textContent = player.username;
                                    voteSelect.appendChild(option);
                                }
                            });
                            
                            // Restore previous selection if it's still valid
                            if (currentVoteSelection && Array.from(voteSelect.options).some(opt => opt.value === currentVoteSelection)) {
                                voteSelect.value = currentVoteSelection;
                            }
                        }
                        
                        // Load dead players with roles to display them
                        fetch(`/api/games/${gameCode}/dead-players-roles`)
                            .then(response => response.json())
                            .then(deadPlayersWithRoles => {
                                const deadPlayerRoles = {};
                                deadPlayersWithRoles.forEach(player => {
                                    deadPlayerRoles[player.username] = player.role;
                                });
                                
                                // Display all players with proper formatting
                                displayPlayersInList(players, deadPlayerRoles);
                                isLoadingPlayers = false; // Reset loading flag
                                resolve(); // Resolve the promise after everything is loaded
                            })
                            .catch(error => {
                                console.error('Error loading dead player roles:', error);
                                // Fallback to basic display without roles
                                displayPlayersInList(players, {});
                                isLoadingPlayers = false; // Reset loading flag
                                resolve(); // Resolve even on error
                            });
                    })
                    .catch(error => {
                        console.error('Error loading players:', error);
                        isLoadingPlayers = false; // Reset loading flag
                        reject(error);
                    });
            });
        }

        function displayPlayersInList(players, deadPlayerRoles) {
            const playersList = document.getElementById('playersList');
            
            // Clear the existing players list completely to prevent duplication
            playersList.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                if (!player.alive) {
                    playerDiv.classList.add('player-dead');
                }
                
                let playerText = player.username;
                if (player.username === username) {
                    playerText += ' (You)';
                }
                if (!player.alive) {
                    const role = deadPlayerRoles[player.username];
                    if (role) {
                        const roleColor = role === 'MAFIA' ? 'text-danger' : 
                                        role === 'DOCTOR' ? 'text-success' : 
                                        role === 'DETECTIVE' ? 'text-info' : 'text-secondary';
                        playerDiv.innerHTML = `<span>${player.username}${player.username === username ? ' (You)' : ''}</span> <span class="${roleColor}">(Dead - ${role})</span>`;
                    } else {
                        playerDiv.textContent = playerText + ' (Dead)';
                    }
                } else {
                    playerDiv.textContent = playerText;
                }
                
                playersList.appendChild(playerDiv);
            });
        }

        function showDayPhase() {
            document.getElementById('dayPhase').style.display = 'block';
            document.getElementById('nightPhase').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            // Update chat system for day phase
            updateChatPhase('DAY', currentPlayerRole, isPlayerAlive);
            
            // Trigger phase transition animation
            if (window.animationManager) {
                document.dispatchEvent(new CustomEvent('phaseChange', {
                    detail: { phase: 'DAY', day: document.getElementById('day').textContent }
                }));
            }
            
            // Add day phase animation classes
            const dayPhase = document.getElementById('dayPhase');
            dayPhase.classList.add('day-phase-enter', 'animate-slide-in-down');
            
            // Show spectator interface for dead players
            if (!isPlayerAlive) {
                document.getElementById('dayPhase').innerHTML = `
                    <div class="alert alert-secondary notification animate-fade-in">
                        <h4>Day Phase - Spectator Mode</h4>
                        <p><strong>You are dead and watching the game.</strong></p>
                        <p>The living players are discussing and voting to eliminate someone they suspect is Mafia.</p>
                        <p>You cannot participate but can observe the proceedings.</p>
                    </div>
                    <div id="votingStatus" class="mt-3 animate-slide-in-up">
                        <h5>Voting Status:</h5>
                        <div id="votesList"></div>
                    </div>
                `;
            }
            
            // Animate vote buttons when they become visible
            setTimeout(() => {
                const voteBtn = document.getElementById('voteBtn');
                const skipBtn = document.getElementById('skipVoteBtn');
                if (voteBtn && window.animationManager) {
                    window.animationManager.animateButton(voteBtn, 'bounce');
                }
                if (skipBtn && window.animationManager) {
                    setTimeout(() => window.animationManager.animateButton(skipBtn, 'bounce'), 200);
                }
            }, 800);
        }

        function showNightPhase() {
            document.getElementById('dayPhase').style.display = 'none';
            document.getElementById('nightPhase').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';
            
            // Update chat system for night phase
            updateChatPhase('NIGHT', currentPlayerRole, isPlayerAlive);
            
            // Trigger phase transition animation
            if (window.animationManager) {
                document.dispatchEvent(new CustomEvent('phaseChange', {
                    detail: { phase: 'NIGHT', day: document.getElementById('day').textContent }
                }));
            }
            
            // Add night phase animation classes
            const nightPhase = document.getElementById('nightPhase');
            nightPhase.classList.add('night-phase-enter', 'animate-slide-in-up');
            
            // Show role-specific night actions only for alive players
            const nightActions = document.getElementById('nightActions');
            if (!isPlayerAlive) {
                nightActions.innerHTML = `
                    <div class="alert alert-secondary notification animate-fade-in">
                        <h4>Night Phase - Spectator Mode</h4>
                        <p><strong>You are dead and watching the game.</strong></p>
                        <p>The living players with special roles are performing their night actions.</p>
                        <p>Wait for the day phase to see the results of tonight's actions.</p>
                    </div>
                `;
                return;
            }
            
            if (currentPlayerRole === 'MAFIA') {
                nightActions.innerHTML = `
                    <div class="alert alert-danger notification animate-slide-in-left">
                        <h5>Mafia Night Action</h5>
                        <p>Vote for a player to eliminate tonight. Your team needs to coordinate the decision.</p>
                        <div id="mafiaTeamInfo" class="mb-3">
                            <h6>Your Mafia Team:</h6>
                            <div id="mafiaMembers">Loading...</div>
                        </div>
                        <div class="mt-3">
                            <label for="mafiaTarget">Your vote to eliminate:</label>
                            <select id="mafiaTarget" class="form-select mb-2 transition-all">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="mafiaActionBtn" class="btn btn-danger action-button hover-lift">Submit Vote</button>
                            <small class="form-text text-muted d-block mt-1">You can change your vote until all team members have voted.</small>
                        </div>
                    </div>
                `;
                // Load Mafia team members and populate target options
                loadMafiaTeamInfo();
                loadMafiaTargets();
                document.getElementById('mafiaActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('mafiaTarget').value;
                    if (!target) {
                        if (window.animationManager) {
                            window.animationManager.showNotification('Please select a target to eliminate.', 'warning');
                        } else {
                            alert('Please select a target to eliminate.');
                        }
                        return;
                    }
                    submitNightAction('KILL', target);
                });
                
                // Refresh Mafia voting status every 3 seconds during night phase
                const mafiaRefreshInterval = setInterval(() => {
                    if (currentPhase === 'NIGHT' && currentPlayerRole === 'MAFIA') {
                        loadMafiaTeamInfo();
                    } else {
                        clearInterval(mafiaRefreshInterval);
                    }
                }, 3000);
            } else if (currentPlayerRole === 'DOCTOR') {
                nightActions.innerHTML = `
                    <div class="alert alert-success notification animate-slide-in-left">
                        <h5>Doctor Night Action</h5>
                        <p>Choose a player to save tonight (including yourself). You can prevent one death.</p>
                        <div class="mt-3">
                            <label for="doctorTarget">Player to save:</label>
                            <select id="doctorTarget" class="form-select mb-2 transition-all">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="doctorActionBtn" class="btn btn-success action-button hover-lift">Save Player</button>
                        </div>
                    </div>
                `;
                // Populate doctor target options and add event listener
                loadDoctorTargets();
                document.getElementById('doctorActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('doctorTarget').value;
                    if (!target) {
                        if (window.animationManager) {
                            window.animationManager.showNotification('Please select a player to save.', 'warning');
                        } else {
                            alert('Please select a player to save.');
                        }
                        return;
                    }
                    submitNightAction('SAVE', target);
                });
            } else if (currentPlayerRole === 'DETECTIVE') {
                nightActions.innerHTML = `
                    <div class="alert alert-info notification animate-slide-in-left">
                        <h5>Detective Night Action</h5>
                        <p>Choose a player to investigate tonight. You will learn if they are Mafia or not.</p>
                        <div id="investigationResult" class="mt-3" style="display: none;">
                            <div class="alert alert-success notification">
                                <h6>Investigation Result:</h6>
                                <div id="investigationMessage"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="detectiveTarget">Player to investigate:</label>
                            <select id="detectiveTarget" class="form-select mb-2 transition-all">
                                <option value="">Select a player...</option>
                            </select>
                            <button id="detectiveActionBtn" class="btn btn-info action-button hover-lift">Investigate Player</button>
                        </div>
                    </div>
                `;
                // Populate detective target options and add event listener
                loadDetectiveTargets();
                document.getElementById('detectiveActionBtn').addEventListener('click', function() {
                    const target = document.getElementById('detectiveTarget').value;
                    if (!target) {
                        if (window.animationManager) {
                            window.animationManager.showNotification('Please select a player to investigate.', 'warning');
                        } else {
                            alert('Please select a player to investigate.');
                        }
                        return;
                    }
                    submitNightAction('INVESTIGATE', target);
                });
            } else {
                nightActions.innerHTML = `
                    <div class="alert alert-secondary notification animate-fade-in">
                        <h5>Night Time</h5>
                        <p>Sleep tight! The night actions are being performed by special roles.</p>
                        <p>Wait for the day phase to begin where you can participate in discussions and voting.</p>
                    </div>
                `;
            }
        }

        function loadMafiaTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('mafiaTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.username !== username && player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function loadMafiaTeamInfo() {
            fetch(`/api/games/${gameCode}/mafia-team/${username}`)
                .then(response => response.json())
                .then(mafiaMembers => {
                    const mafiaTeamDiv = document.getElementById('mafiaMembers');
                    if (mafiaTeamDiv) {
                        mafiaTeamDiv.innerHTML = '';
                        
                        if (mafiaMembers.length === 0) {
                            mafiaTeamDiv.innerHTML = '<p class="text-muted">No team information available</p>';
                            return;
                        }
                        
                        // Load voting status to combine with member info
                        fetch(`/api/games/${gameCode}/mafia-votes/${username}`)
                            .then(response => response.json())
                            .then(votingStatus => {
                                mafiaMembers.forEach(member => {
                                    const memberDiv = document.createElement('div');
                                    memberDiv.className = 'mb-1';
                                    
                                    let memberText = member.username;
                                    if (member.isYou) {
                                        memberText += ' (You)';
                                    }
                                    if (!member.alive) {
                                        memberText += ' (Dead)';
                                        memberDiv.className += ' text-muted';
                                        memberDiv.style.textDecoration = 'line-through';
                                    }
                                    
                                    // Find voting status for this member
                                    const memberStatus = votingStatus.find(v => v.username === member.username);
                                    let statusText = '';
                                    let statusClass = '';
                                    
                                    if (memberStatus) {
                                        if (memberStatus.hasVoted) {
                                            statusText = ` - Voted for ${memberStatus.target}`;
                                            statusClass = 'text-success';
                                        } else {
                                            statusText = ' - Not voted yet';
                                            statusClass = 'text-warning';
                                        }
                                    }
                                    
                                    memberDiv.innerHTML = `<span class="text-danger">ðŸ”´ ${memberText}</span><span class="${statusClass}">${statusText}</span>`;
                                    mafiaTeamDiv.appendChild(memberDiv);
                                });
                                
                                // Add summary if needed
                                const votedCount = votingStatus.filter(m => m.hasVoted).length;
                                const totalCount = votingStatus.length;
                                
                                if (votedCount < totalCount) {
                                    const summaryDiv = document.createElement('div');
                                    summaryDiv.className = 'mt-2 small text-info';
                                    summaryDiv.innerHTML = `<em>Waiting for ${totalCount - votedCount} more vote(s)...</em>`;
                                    mafiaTeamDiv.appendChild(summaryDiv);
                                }
                            })
                            .catch(error => {
                                console.error('Error loading voting status:', error);
                                // Fallback to basic member display without voting status
                                mafiaMembers.forEach(member => {
                                    const memberDiv = document.createElement('div');
                                    memberDiv.className = 'mb-1';
                                    
                                    let memberText = member.username;
                                    if (member.isYou) {
                                        memberText += ' (You)';
                                    }
                                    if (!member.alive) {
                                        memberText += ' (Dead)';
                                        memberDiv.className += ' text-muted';
                                        memberDiv.style.textDecoration = 'line-through';
                                    }
                                    
                                    memberDiv.innerHTML = `<span class="text-danger">ðŸ”´ ${memberText}</span>`;
                                    mafiaTeamDiv.appendChild(memberDiv);
                                });
                            });
                    }
                })
                .catch(error => {
                    console.error('Error loading Mafia team:', error);
                    const mafiaTeamDiv = document.getElementById('mafiaMembers');
                    if (mafiaTeamDiv) {
                        mafiaTeamDiv.innerHTML = '<p class="text-muted">Unable to load team information</p>';
                    }
                });
        }

        function loadDoctorTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('doctorTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function loadDetectiveTargets() {
            fetch(`/api/games/${gameCode}/players`)
                .then(response => response.json())
                .then(players => {
                    const targetSelect = document.getElementById('detectiveTarget');
                    if (targetSelect) {
                        targetSelect.innerHTML = '<option value="">Select a player...</option>';
                        players.forEach(player => {
                            if (player.username !== username && player.alive) {
                                const option = document.createElement('option');
                                option.value = player.username;
                                option.textContent = player.username;
                                targetSelect.appendChild(option);
                            }
                        });
                    }
                });
        }

        function submitNightAction(actionType, targetUsername) {
            const nightActionData = {
                actorUsername: username,
                targetUsername: targetUsername,
                actionType: actionType
            };
            
            fetch(`/api/game-logic/${gameCode}/night-action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nightActionData)
            })
            .then(response => {
                if (response.ok) {
                    if (currentPlayerRole === 'MAFIA') {
                        // Don't show notification - vote status will update automatically
                        // Don't disable interface for Mafia - they can change votes
                        loadMafiaTeamInfo(); // Refresh voting status
                        // Play mafia action sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('NIGHT_ACTION', { role: 'MAFIA' });
                        }
                    } else if (currentPlayerRole === 'DETECTIVE' && actionType === 'INVESTIGATE') {
                        hasActedThisNight = true;
                        
                        // Play detective investigation sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('NIGHT_ACTION', { role: 'DETECTIVE' });
                        }
                        
                        // Show investigation result immediately (simulated for now)
                        // In a real implementation, this would come via WebSocket
                        setTimeout(() => {
                            displayInvestigationResult(targetUsername);
                        }, 1000);
                        
                        // Disable the action interface
                        disableNightActionInterface();
                        
                        // Reduce refresh frequency after acting
                        setAutoRefreshInterval(15000);
                    } else {
                        hasActedThisNight = true;
                        
                        // Play doctor save sound for DOCTOR role
                        if (window.soundManager && currentPlayerRole === 'DOCTOR') {
                            window.soundManager.playGameEvent('NIGHT_ACTION', { role: 'DOCTOR' });
                        }
                        
                        // Disable the action interface for non-Mafia roles
                        disableNightActionInterface();
                        
                        // Reduce refresh frequency after acting
                        setAutoRefreshInterval(15000);
                    }
                } else {
                    return response.json().then(error => {
                        throw new Error(error.message || 'Failed to perform night action');
                    });
                }
            })
            .catch(error => {
                console.error('Error performing night action:', error);
                showNotification('Error: ' + error.message, 'error');
                // Play error sound
                if (window.soundManager) {
                    window.soundManager.playGameEvent('ERROR');
                }
            });
        }

        function disableNightActionInterface() {
            // Disable all night action buttons and selects
            const buttons = document.querySelectorAll('#nightActions button');
            const selects = document.querySelectorAll('#nightActions select');
            
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Action Completed';
                btn.className = 'btn btn-secondary';
            });
            
            selects.forEach(select => {
                select.disabled = true;
            });
        }

        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('gameNotifications');
            const notificationText = document.getElementById('notificationText');
            
            // Set alert class based on type
            notificationText.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            notificationText.textContent = message;
            notifications.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notifications.style.display = 'none';
            }, 5000);
        }

        function showGameOver(winner) {
            document.getElementById('dayPhase').style.display = 'none';
            document.getElementById('nightPhase').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            
            // Add game over animation
            const gameOverElement = document.getElementById('gameOver');
            gameOverElement.classList.add('game-over', 'animate-zoom-in');
            
            if (winner === 'MAFIA') {
                gameOverElement.classList.add('lose');
            } else if (winner === 'CITIZENS') {
                gameOverElement.classList.add('win');
            }
            
            const winnerMessage = document.getElementById('winnerMessage');
            let winnerHtml = '';
            if (winner === 'MAFIA') {
                winnerHtml = '<h5 class="text-danger animate-pulse">Mafia Wins!</h5><p class="animate-fade-in">The Mafia has successfully taken over the town.</p>';
                // Play Mafia win sound (only once per game)
                if (window.soundManager) {
                    window.soundManager.playGameEvent('WIN_MAFIA');
                }
            } else if (winner === 'CITIZENS') {
                winnerHtml = '<h5 class="text-success animate-bounce">Citizens Win!</h5><p class="animate-fade-in">All Mafia members have been eliminated!</p>';
                // Play Town win sound (only once per game)
                if (window.soundManager) {
                    window.soundManager.playGameEvent('WIN_TOWN');
                }
            } else {
                winnerHtml = '<h5 class="text-info animate-fade-in">Game Over!</h5><p class="animate-fade-in">The game has ended.</p>';
                // Play general game end sound
                if (window.soundManager) {
                    window.soundManager.playGameEvent('GAME_END');
                }
            }
            
            // Load and display all players with their roles
            fetch(`/api/games/${gameCode}/players-with-roles`)
                .then(response => response.json())
                .then(players => {
                    let rolesHtml = '<div class="mt-4 animate-slide-in-up"><h6>Player Roles:</h6><div class="row">';
                    players.forEach((player, index) => {
                        const roleColor = player.role === 'MAFIA' ? 'text-danger' : 
                                        player.role === 'DOCTOR' ? 'text-success' : 
                                        player.role === 'DETECTIVE' ? 'text-info' : 'text-secondary';
                        const aliveStatus = player.alive ? '' : ' (Dead)';
                        const animationDelay = index * 100;
                        rolesHtml += `
                            <div class="col-md-6 mb-2">
                                <div class="card hover-lift transition-all" style="animation-delay: ${animationDelay}ms;">
                                    <div class="card-body p-2">
                                        <strong>${player.username}${aliveStatus}</strong><br>
                                        <span class="${roleColor}">${player.role}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    rolesHtml += '</div></div>';
                    winnerMessage.innerHTML = winnerHtml + rolesHtml;
                    
                    // Animate role cards
                    setTimeout(() => {
                        document.querySelectorAll('.card').forEach((card, index) => {
                            setTimeout(() => {
                                card.classList.add('animate-slide-in-left');
                            }, index * 100);
                        });
                    }, 500);
                })
                .catch(error => {
                    console.error('Error loading player roles:', error);
                    winnerMessage.innerHTML = winnerHtml + '<p class="mt-3 text-muted animate-fade-in">Could not load player roles.</p>';
                });
        }

        // Vote button handler
        document.getElementById('voteBtn').addEventListener('click', function() {
            if (!isPlayerAlive) {
                if (window.animationManager) {
                    window.animationManager.showNotification('Dead players cannot vote! You are in spectator mode.', 'error');
                } else {
                    showNotification('Dead players cannot vote! You are in spectator mode.', 'error');
                }
                return;
            }
            
            const selectedPlayer = document.getElementById('voteSelect').value;
            if (!selectedPlayer) {
                if (window.animationManager) {
                    window.animationManager.showNotification('Please select a player to vote for.', 'warning');
                } else {
                    alert('Please select a player to vote for.');
                }
                return;
            }
            
            // Animate vote button
            if (window.animationManager) {
                window.animationManager.animateButton(this, 'pulse');
            }
            
            // Check if player has already voted
            fetch(`/api/game-logic/${gameCode}/has-voted/${username}`)
                .then(response => response.json())
                .then(hasVoted => {
                    if (hasVoted) {
                        if (window.animationManager) {
                            window.animationManager.showNotification('You have already voted!', 'warning');
                        } else {
                            alert('You have already voted!');
                        }
                        return;
                    }
                    
                    // Submit vote
                    const voteData = {
                        voterUsername: username,
                        targetUsername: selectedPlayer,
                        skip: false
                    };
                    
                    fetch(`/api/game-logic/${gameCode}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(voteData)
                    })
                    .then(response => {
                        if (response.ok) {
                            // Trigger vote animation event
                            if (window.animationManager) {
                                document.dispatchEvent(new CustomEvent('voteEvent', {
                                    detail: { voter: username, target: selectedPlayer, isSkip: false }
                                }));
                                window.animationManager.showNotification(`Successfully voted for ${selectedPlayer}`, 'success');
                            } else {
                                alert(`Successfully voted for ${selectedPlayer}`);
                            }
                            
                            document.getElementById('voteSelect').value = '';
                            loadVotingStatus();
                            loadGameState();
                            // Play vote sound
                            if (window.soundManager) {
                                window.soundManager.playGameEvent('VOTE');
                                // Temporarily mute elimination sounds since this player just voted
                                window.soundManager.muteEliminationTemporarily(8000);
                            }
                        } else {
                            return response.json().then(error => {
                                throw new Error(error.message || 'Failed to vote');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error voting:', error);
                        if (window.animationManager) {
                            window.animationManager.showNotification('Error: ' + error.message, 'error');
                        } else {
                            alert('Error: ' + error.message);
                        }
                        // Play error sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('ERROR');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error checking vote status:', error);
                    if (window.animationManager) {
                        window.animationManager.showNotification('Error checking vote status', 'error');
                    } else {
                        alert('Error checking vote status');
                    }
                });
        });

        // Skip vote button handler
        document.getElementById('skipVoteBtn').addEventListener('click', function() {
            if (!isPlayerAlive) {
                if (window.animationManager) {
                    window.animationManager.showNotification('Dead players cannot vote! You are in spectator mode.', 'error');
                } else {
                    showNotification('Dead players cannot vote! You are in spectator mode.', 'error');
                }
                return;
            }
            
            // Animate skip vote button
            if (window.animationManager) {
                window.animationManager.animateButton(this, 'shake');
            }
            
            // Check if player has already voted
            fetch(`/api/game-logic/${gameCode}/has-voted/${username}`)
                .then(response => response.json())
                .then(hasVoted => {
                    if (hasVoted) {
                        if (window.animationManager) {
                            window.animationManager.showNotification('You have already voted!', 'warning');
                        } else {
                            alert('You have already voted!');
                        }
                        return;
                    }
                    
                    // Submit skip vote
                    const voteData = {
                        voterUsername: username,
                        targetUsername: null,
                        skip: true
                    };
                    
                    fetch(`/api/game-logic/${gameCode}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(voteData)
                    })
                    .then(response => {
                        if (response.ok) {
                            // Trigger vote animation event
                            if (window.animationManager) {
                                document.dispatchEvent(new CustomEvent('voteEvent', {
                                    detail: { voter: username, target: null, isSkip: true }
                                }));
                                window.animationManager.showNotification('Successfully skipped vote', 'info');
                            } else {
                                alert('Successfully skipped vote');
                            }
                            
                            loadVotingStatus();
                            loadGameState();
                            // Play skip vote sound
                            if (window.soundManager) {
                                window.soundManager.playGameEvent('SKIP_VOTE');
                                // Temporarily mute elimination sounds since this player just voted (skip)
                                window.soundManager.muteEliminationTemporarily(8000);
                            }
                        } else {
                            return response.json().then(error => {
                                throw new Error(error.message || 'Failed to skip vote');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error skipping vote:', error);
                        if (window.animationManager) {
                            window.animationManager.showNotification('Error: ' + error.message, 'error');
                        } else {
                            alert('Error: ' + error.message);
                        }
                        // Play error sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('ERROR');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error checking vote status:', error);
                    if (window.animationManager) {
                        window.animationManager.showNotification('Error checking vote status', 'error');
                    } else {
                        alert('Error checking vote status');
                    }
                });
        });

        // Function to load voting status
        function loadVotingStatus() {
            fetch(`/api/game-logic/${gameCode}/vote-status`)
                .then(response => response.json())
                .then(votingStatus => {
                    const votesList = document.getElementById('votesList');
                    if (!votesList) return; // Element might not exist for dead players
                    
                    votesList.innerHTML = '';
                    
                    Object.entries(votingStatus).forEach(([playerName, status]) => {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'vote-status-item';
                        
                        let statusClass = 'not-voted';
                        let statusText = status;
                        
                        if (status.startsWith('Voted')) {
                            statusClass = 'voted';
                        }
                        
                        statusDiv.innerHTML = `
                            <span class="player-name">${playerName}:</span>
                            <span class="vote-status ${statusClass}">${statusText}</span>
                        `;
                        votesList.appendChild(statusDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading voting status:', error);
                });
        }

        // Refresh button handler
        document.getElementById('refreshBtn').addEventListener('click', loadGameState);

        // Initial load
        loadGameState();

        // Start with initial auto-refresh
        setAutoRefreshInterval(5000);

        // Initialize WebSocket for real-time events
        initializeWebSocket();

        // Auto-refresh every 5 seconds
        setInterval(loadGameState, 5000);
        
        // Initialize sound system
        window.addEventListener('DOMContentLoaded', function() {
            if (window.soundManager) {
                // Update sound button state
                const settings = window.soundManager.getSettings();
                const icon = document.getElementById('soundToggleIcon');
                const btn = document.getElementById('soundToggleBtn');
                if (!settings.enabled) {
                    icon.className = 'fas fa-volume-mute';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-danger');
                }
                
                // Play game start sound
                setTimeout(() => {
                    window.soundManager.playGameEvent('GAME_START');
                }, 1000);
            }
        });

        // Auto-refresh every 5 seconds
        setInterval(loadGameState, 5000);

        // Also add investigation result display area
        function displayInvestigationResult(targetUsername) {
            // Fetch the actual investigation result from the backend
            fetch(`/api/games/${gameCode}/investigation-result/${username}/${targetUsername}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Investigation result not available yet');
                    }
                })
                .then(result => {
                    // Show the investigation result area
                    const resultDiv = document.getElementById('investigationResult');
                    const messageDiv = document.getElementById('investigationMessage');
                    
                    if (resultDiv && messageDiv) {
                        let resultClass = result.isMafia ? 'text-danger' : 'text-success';
                        let resultIcon = result.isMafia ? 'ðŸ”´' : 'ðŸŸ¢';
                        
                        messageDiv.innerHTML = `
                            <p><strong>Investigation Complete!</strong></p>
                            <p>You investigated <strong>${result.targetUsername}</strong>:</p>
                            <p class="${resultClass}"><strong>${resultIcon} ${result.message}</strong></p>
                        `;
                        resultDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error getting investigation result:', error);
                    // Show a pending message if result not available yet
                    const resultDiv = document.getElementById('investigationResult');
                    const messageDiv = document.getElementById('investigationMessage');
                    
                    if (resultDiv && messageDiv) {
                        messageDiv.innerHTML = `
                            <p><strong>Investigation in Progress...</strong></p>
                            <p>You investigated <strong>${targetUsername}</strong>.</p>
                            <p class="text-warning">Results will be available shortly. Try refreshing in a moment.</p>
                        `;
                        resultDiv.style.display = 'block';
                        
                        // Try again after a short delay
                        setTimeout(() => {
                            displayInvestigationResult(targetUsername);
                        }, 2000);
                    }
                });
        }

        function startPhaseTimer(duration) {
            clearTimer();
            
            const timerElement = document.getElementById('phaseTimer');
            const timerText = document.getElementById('timerText');
            
            timerElement.style.display = 'block';
            let timeLeft = duration;
            
            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Play timer warning sounds
                if (window.soundManager) {
                    if (timeLeft === 30) {
                        window.soundManager.playGameEvent('TIMER_WARNING');
                    } else if (timeLeft === 10) {
                        window.soundManager.playGameEvent('TIMER_URGENT');
                    }
                }
                
                if (timeLeft <= 0) {
                    // Auto advance phase when timer expires
                    advancePhaseAutomatically();
                    clearTimer();
                } else {
                    timeLeft--;
                }
            }
            
            updateTimer(); // Update immediately
            phaseTimer = setInterval(updateTimer, 1000);
        }

        function clearTimer() {
            if (phaseTimer) {
                clearInterval(phaseTimer);
                phaseTimer = null;
            }
            document.getElementById('phaseTimer').style.display = 'none';
        }

        function advancePhaseAutomatically() {
            fetch(`/api/game-logic/${gameCode}/advance-phase`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Phase advanced automatically due to timer', 'info');
                    loadGameState();
                } else {
                    console.error('Failed to advance phase automatically');
                }
            })
            .catch(error => {
                console.error('Error advancing phase automatically:', error);
            });
        }

        function setAutoRefreshInterval(interval) {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(loadGameState, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Action History Functions
        function loadActionHistory() {
            fetch(`/api/history/game/${gameCode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load action history');
                    }
                    return response.json();
                })
                .then(actions => {
                    displayActionHistory(actions);
                })
                .catch(error => {
                    console.error('Error loading action history:', error);
                    document.getElementById('actionHistoryPanel').innerHTML = 
                        '<p class="text-muted small">Unable to load action history</p>';
                });
        }

        function displayActionHistory(actions) {
            const panel = document.getElementById('actionHistoryPanel');
            
            if (!actions || actions.length === 0) {
                panel.innerHTML = '<p class="text-muted small">No actions recorded yet</p>';
                return;
            }

            // Sort actions by timestamp (most recent first)
            actions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Take only the last 10 actions for the game view
            const recentActions = actions.slice(0, 10);

            let html = '<div class="action-history-items">';
            
            recentActions.forEach(action => {
                const actionDiv = createActionHistoryItem(action);
                html += actionDiv;
            });

            html += '</div>';
            
            if (actions.length > 10) {
                html += `<div class="mt-2"><small class="text-muted">Showing latest 10 of ${actions.length} actions</small></div>`;
            }

            panel.innerHTML = html;
        }

        function createActionHistoryItem(action) {
            const time = new Date(action.timestamp).toLocaleTimeString();
            const actionIcon = getActionIcon(action.actionType);
            const actionClass = getActionClass(action.actionType);
            
            return `
                <div class="action-item mb-2 p-2 border rounded ${actionClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="action-content">
                            <small class="text-muted">${time} - Day ${action.day}</small>
                            <div class="action-description">
                                ${actionIcon} ${action.details || 'No details available'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getActionIcon(actionType) {
            const icons = {
                'GAME_START': 'ðŸŽ®',
                'GAME_END': 'ðŸ',
                'PHASE_CHANGE': 'ðŸ”„',
                'VOTE': 'ðŸ—³ï¸',
                'SKIP_VOTE': 'â­ï¸',
                'ELIMINATION': 'ðŸ’€',
                'SYSTEM_EVENT': 'âš™ï¸'
            };
            return icons[actionType] || 'ðŸ“‹';
        }

        function getActionClass(actionType) {
            const classes = {
                'GAME_START': 'border-success',
                'GAME_END': 'border-warning',
                'PHASE_CHANGE': 'border-info',
                'VOTE': 'border-primary',
                'SKIP_VOTE': 'border-secondary',
                'ELIMINATION': 'border-danger',
                'SYSTEM_EVENT': 'border-light'
            };
            return classes[actionType] || 'border-light';
        }

        // Sound Integration Functions
        function toggleSound() {
            const enabled = window.soundManager.toggle();
            const icon = document.getElementById('soundToggleIcon');
            const btn = document.getElementById('soundToggleBtn');
            if (enabled) {
                icon.className = 'fas fa-volume-up';
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-outline-secondary');
            } else {
                icon.className = 'fas fa-volume-mute';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-outline-danger');
            }
        }
        
        function initializeSoundSystem() {
            // Update sound button state
            const settings = window.soundManager.getSettings();
            updateSoundButtonIcon(settings.enabled);
            
            // Play game start sound
            window.soundManager.playGameEvent('GAME_START');
        }
        
        function updateSoundButtonIcon(enabled) {
            const icon = document.getElementById('soundToggleIcon');
            const btn = document.getElementById('soundToggleBtn');
            if (icon && btn) {
                if (enabled) {
                    icon.className = 'fas fa-volume-up';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-outline-secondary');
                } else {
                    icon.className = 'fas fa-volume-mute';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-danger');
                }
            }
        }
        
        function playPhaseChangeSound(newPhase) {
            window.soundManager.playGameEvent('PHASE_CHANGE', { phase: newPhase });
        }
        
        function playVoteSound(isSkip = false) {
            if (isSkip) {
                window.soundManager.playGameEvent('SKIP_VOTE');
            } else {
                window.soundManager.playGameEvent('VOTE');
            }
        }
        
        function playNightActionSound(role) {
            window.soundManager.playGameEvent('NIGHT_ACTION', { role: role });
        }
        
        function playEliminationSound() {
            window.soundManager.playGameEvent('ELIMINATION');
        }
        
        function playTimerSound(timeLeft) {
            if (timeLeft === 30) {
                window.soundManager.playGameEvent('TIMER_WARNING');
            } else if (timeLeft === 10) {
                window.soundManager.playGameEvent('TIMER_URGENT');
            }
        }
        
        function playGameEndSound(winner) {
            if (winner === 'MAFIA') {
                window.soundManager.playGameEvent('WIN_MAFIA');
            } else {
                window.soundManager.playGameEvent('WIN_TOWN');
            }
        }
        
        function playActionCompleteSound() {
            window.soundManager.playGameEvent('ACTION_COMPLETE');
        }
        
        function playErrorSound() {
            window.soundManager.playGameEvent('ERROR');
        }

        // Initialize WebSocket for real-time events
        function initializeWebSocket() {
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected to WebSocket for real-time game events');
                
                // Subscribe to game events
                stompClient.subscribe(`/topic/game/${gameCode}`, function(message) {
                    const event = JSON.parse(message.body);
                    handleGameEvent(event);
                });
                
                // Subscribe to private messages  
                stompClient.subscribe(`/user/queue/private`, function(message) {
                    const event = JSON.parse(message.body);
                    handlePrivateEvent(event);
                });
            }, function(error) {
                console.error('WebSocket connection error:', error);
                // Continue without WebSocket - game will still work via REST
            });
            
            // Store client for potential cleanup
            window.gameStompClient = stompClient;
        }
        
        // Handle WebSocket game events
        function handleGameEvent(event) {
            console.log('Received game event:', event);
            
            switch(event.type) {
                case 'PLAYER_DIED_LAST_NIGHT':
                    if (event.payload && event.payload.target) {
                        console.log('Player died last night:', event.payload.target);
                        // Play night kill elimination sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('ELIMINATION', {
                                eliminatedPlayer: event.payload.target,
                                isNightKill: true
                            });
                        }
                    }
                    break;
                    
                case 'PLAYER_ELIMINATED':
                    if (event.payload && event.payload.target) {
                        console.log('Player eliminated by voting:', event.payload.target);
                        // Play day elimination sound
                        if (window.soundManager) {
                            window.soundManager.playGameEvent('ELIMINATION', {
                                eliminatedPlayer: event.payload.target,
                                isDayElimination: true,
                                reason: event.payload.reason
                            });
                        }
                    }
                    break;
                    
                case 'PHASE_CHANGE':
                    // Phase change sounds are already handled by the polling system
                    break;
                    
                case 'VOTE_CAST':
                    // Vote sounds are already handled by the vote buttons
                    break;
                    
                default:
                    console.log('Unhandled game event:', event.type);
            }
        }
        
        // Handle private WebSocket events
        function handlePrivateEvent(event) {
            console.log('Received private event:', event);
            // Handle private messages like investigation results
        }
        
        // Page initialization
        function initializePage() {
            console.log('Initializing game page...');
            
            // Initialize sound system
            if (window.soundManager) {
                initializeSoundSystem();
            }
            
            // Initialize WebSocket for game events
            initializeWebSocket();
            
            // Initialize chat system
            initializeChat(gameCode, username);
            
            // Load initial game state
            loadGameState();
            
            // Set up auto-refresh
            setAutoRefreshInterval(5000);
        }
        
        // Wait for page to load, then initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for all scripts to load
            setTimeout(initializePage, 100);
        });
    </script>
</body>
</html>